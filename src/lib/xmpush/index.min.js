const conf = require('./conf')

const debug = conf.debug

debug && console.log('debug', conf)

const WXDATA = 'http://dev.zhouyu.com:6789'

// 注册推送服务，收集设备信息
const xmpushRegisterPush = () => {
  const data = {
    start_time: +new Date(),
    app_key: conf.app_key
  }

  try {
    data.systemInfo = wx.getSystemInfoSync()
  } catch (err) {
    debug && console.log('debug', err)
  }

  try {
    data.batteryInfo = wx.getBatteryInfoSync()
  } catch (err) {
    debug && console.log('debug', err)
  }

  let count = 0
  let maxCount

  if (conf.getLocation) {
    maxCount = 5

    wx.getLocation({
      type: 'wgs84',
      altitude: true,
      success (res) {
        data.location = res

        count++

        handle()
      },
      fail (err) {
        debug && console.log('debug', err)

        count++

        handle()
      }
    })
  } else {
    maxCount = 4
  }

  const handle = () => {
    if (count === maxCount) {
      data.end_time = +new Date()

      debug && console.log('debug', JSON.stringify(data), data, WXDATA)
    }
  }

  wx.getNetworkType({
    success (res) {
      data.networkType = res.networkType

      count++

      handle()
    },
    fail (err) {
      debug && console.log('debug', err)

      count++

      handle()
    }
  })

  wx.getConnectedWifi({
    success (res) {
      data.wifiInfo = res.wifi

      count++
    },
    fail (err) {
      debug && console.log('debug', err)

      count++

      handle()
    }
  })

  wx.getHCEState({
    success (res) {
      data.hCEState = res

      count++

      handle()
    },
    fail (err) {
      debug && console.log('debug', err)

      count++

      handle()
    },
  })

  wx.getScreenBrightness({
    success (res) {
      data.screenBrightness = res.value // 0 ~ 1，0 最暗，1 最亮

      count++

      handle()
    },
    fail (err) {
      debug && console.log('debug', err)

      count++

      handle()
    },
  })
}

export {
  xmpushRegisterPush,
}

export default {
  xmpushRegisterPush,
}
